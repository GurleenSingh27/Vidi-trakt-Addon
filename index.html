<!doctype html>
<meta charset="utf-8">
<title>Connect Trakt</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:20px;max-width:820px}
  .row{display:flex;gap:.6rem;flex-wrap:wrap}
  .btn{display:inline-block;padding:.8rem 1rem;border:1px solid #ccc;border-radius:10px;cursor:pointer;background:#f6f6f6}
  .code{font-size:24px;font-weight:800;letter-spacing:2px}
  #log{background:#111;color:#eee;padding:12px;border-radius:8px;min-height:120px;white-space:pre-wrap}
  small{color:#666}
</style>

<h1>Connect Trakt</h1>
<p>This links your Trakt account for scrobbling (no watchlists).</p>

<div class="row">
  <button class="btn" id="btnPing">Ping API</button>
  <button class="btn" id="btnGet">Get Device Code</button>
  <a class="btn" id="btnActivate" target="_blank" rel="noopener" href="https://trakt.tv/activate">Open trakt.tv/activate</a>
  <button class="btn" id="btnPoll">Start Auto-Poll</button>
</div>

<p><b>User Code:</b> <span id="userCode" class="code">────</span></p>
<p><b>Device Code:</b> <span id="deviceCode">────</span></p>

<h3>Log</h3>
<pre id="log">{}</pre>
<small>Backend: <span id="burl"></span></small>

<script>
  // ===== CONFIG =====
  const BACKEND = "https://vidi-trakt-backend-q2u2.vercel.app/api"; // keep /api
  document.getElementById('burl').textContent = BACKEND;

  // ===== LOG + ERROR CAPTURE =====
  const $ = s => document.querySelector(s);
  const log = o => $('#log').textContent = typeof o === 'string' ? o : JSON.stringify(o, null, 2);
  window.addEventListener('error', e => log({ js_error: e.message }));
  window.addEventListener('unhandledrejection', e => log({ unhandled_promise: String(e.reason) }));

  let device_code=null, expiresAt=0, intervalMs=5000, polling=false;

  // Ping backend to confirm CORS/origin and URL
  $('#btnPing').onclick = async () => {
    try {
      const echo = await fetch(`${BACKEND}/echo`).then(r => r.json());
      // debug is optional; if present, show env flags
      let debug = null;
      try { debug = await fetch(`${BACKEND}/debug`).then(r => r.json()); } catch {}
      log({ ping_status: 200, echo, debug });
    } catch (err) {
      log({ ping_error: String(err), backend: BACKEND });
    }
  };

  // Request device code
  $('#btnGet').onclick = async () => {
    try {
      const r = await fetch(`${BACKEND}/trakt/device`, { method: 'POST' }); // no headers → no preflight
      const text = await r.text();
      let d; try { d = JSON.parse(text); } catch {}
      log({ status: r.status, body: d || text });

      if (r.ok && d && d.user_code) {
        $('#userCode').textContent  = d.user_code;
        $('#deviceCode').textContent = (device_code = d.device_code);
        intervalMs = (d.interval || 5) * 1000;
        expiresAt  = Date.now() + (d.expires_in || 600) * 1000;
        $('#btnActivate').href = d.verification_url || 'https://trakt.tv/activate';
      }
    } catch (err) {
      log({ fetch_error: String(err) });
    }
  };

  // Poll once
  async function pollOnce(){
    if(!device_code) { log({ error:'Get device code first' }); return null; }
    if(Date.now()>expiresAt){ log({ status:'expired' }); return null; }

    try{
      const r = await fetch(`${BACKEND}/trakt/poll`, {
        method:'POST',
        body:`device_code=${encodeURIComponent(device_code)}`
      });
      const text = await r.text();
      let p; try { p = JSON.parse(text); } catch {}
      log({ status: r.status, body: p || text });

      if (p && p.nextPollAddSec) intervalMs += p.nextPollAddSec*1000;
      if (p && p.status === 'ok' && p.access_token){
        const tokens = {
          access_token: p.access_token,
          refresh_token: p.refresh_token,
          expires_at: Date.now() + p.expires_in*1000
        };
        localStorage.setItem('trakt_tokens_v1', JSON.stringify(tokens));
        const payload = { type:'trakt-auth', tokens };
        try { window.parent?.postMessage(payload, '*'); } catch(e){}
        try { window.webkit?.messageHandlers?.trakt?.postMessage?.(payload); } catch(e){}
        try { window.location = `vidi://trakt-auth?access_token=${encodeURIComponent(tokens.access_token)}&refresh_token=${encodeURIComponent(tokens.refresh_token)}` } catch(e){}
      }
      return p || null;
    }catch(err){
      log({ poll_error: String(err) });
      return null;
    }
  }

  // Auto-poll loop
  $('#btnPoll').onclick = async ()=>{
    if(polling) return; polling = true;
    while(polling){
      const p = await pollOnce();
      if(!p || p.status==='ok' || p.status==='expired'){ polling=false; break; }
      await new Promise(res=>setTimeout(res, intervalMs));
    }
  };

  // Show connected if token is already saved
  try {
    const t = JSON.parse(localStorage.getItem('trakt_tokens_v1')||'null');
    if(t && t.access_token) log({ connected:true });
  } catch {}
</script>
