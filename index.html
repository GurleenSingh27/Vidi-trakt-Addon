<!doctype html>
<meta charset="utf-8">
<title>Trakt Connect</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:20px;max-width:820px}
  .btn{display:inline-block;padding:.8rem 1rem;border:1px solid #ccc;border-radius:10px;cursor:pointer}
  .code{font-size:24px;font-weight:800;letter-spacing:2px}
  #log{background:#111;color:#eee;padding:12px;border-radius:8px;min-height:100px;white-space:pre-wrap}
</style>

<h1>Connect Trakt</h1>
<p>This links your Trakt account for scrobbling (no watchlists).</p>

<div>
  <button class="btn" id="btnGet">Get Device Code</button>
  <a class="btn" id="btnActivate" target="_blank" rel="noopener">Open trakt.tv/activate</a>
  <button class="btn" id="btnPoll">Start Auto-Poll</button>
</div>

<p><b>User Code:</b> <span id="userCode" class="code">----</span></p>
<p><b>Device Code:</b> <span id="deviceCode">----</span></p>

<h3>Log</h3>
<pre id="log">{}</pre>

<script>
  // ---- CHANGE THESE TWO ----
  const BACKEND   = "https://vidi-trakt-backend-q2u2.vercel.app/api"; // your Vercel backend base
  const CLIENT_ID = "85614a3ca3a24906aa30803018774030709c8d1fb284950f9bc57740c6d37b16";                 // public client_id (NOT secret)

  const $=s=>document.querySelector(s);
  const log=o=>$('#log').textContent=typeof o==='string'?o:JSON.stringify(o,null,2);

  let device_code=null, expiresAt=0, intervalMs=5000, polling=false;

  // 1) Get device code
  $('#btnGet').onclick = async () => {
    const r = await fetch(`${BACKEND}/trakt/device`, { method:'POST' });
    const d = await r.json().catch(()=>null);
    if(!d){ log({error:'bad response'}); return; }
    log(d);
    if(r.ok && d.user_code){
      $('#userCode').textContent = d.user_code;
      $('#deviceCode').textContent = device_code = d.device_code;
      intervalMs = (d.interval || 5)*1000;
      expiresAt = Date.now() + (d.expires_in || 600)*1000;
      $('#btnActivate').href = d.verification_url || 'https://trakt.tv/activate';
    }
  };

  // 2) Poll once
  async function pollOnce(){
    if(!device_code) return log({error:'Get device code first'});
    if(Date.now()>expiresAt) return log({status:'expired'});
    const r = await fetch(`${BACKEND}/trakt/poll`, { method:'POST', body:`device_code=${encodeURIComponent(device_code)}` });
    const p = await r.json().catch(()=>null);
    if(!p){ log({error:'poll parse failed'}); return null; }
    log(p);
    if(p.nextPollAddSec) intervalMs += p.nextPollAddSec*1000;

    if(p.status==='ok' && p.access_token){
      const tokens = { access_token:p.access_token, refresh_token:p.refresh_token, expires_at: Date.now() + p.expires_in*1000 };
      localStorage.setItem('trakt_tokens_v1', JSON.stringify(tokens));

      // notify host app
      const payload = { type:'trakt-auth', tokens };
      try { window.parent?.postMessage(payload, '*'); } catch(e){}
      try { window.webkit?.messageHandlers?.trakt?.postMessage?.(payload); } catch(e){}
      try { window.location = `vidi://trakt-auth?access_token=${encodeURIComponent(tokens.access_token)}&refresh_token=${encodeURIComponent(tokens.refresh_token)}` } catch(e){}

      log({ connected:true });
    }
    return p;
  }

  // 3) Auto-poll loop
  $('#btnPoll').onclick = async ()=>{
    if(polling) return; polling = true;
    while(polling){
      const p = await pollOnce();
      if(!p || p.status==='ok' || p.status==='expired'){ polling=false; break; }
      await new Promise(res=>setTimeout(res, intervalMs));
    }
  };

  // Show connected if token already saved
  try { const t = JSON.parse(localStorage.getItem('trakt_tokens_v1')||'null'); if(t && t.access_token) log({connected:true}); } catch {}
</script>
